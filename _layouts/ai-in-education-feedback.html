<!DOCTYPE html>
<html class="has-background-light" lang="{{ page.lang | default: site.lang | default: 'en' }}">

  {%- include ai-in-education-head.html -%}

  <body>
 <script>
        // Defines the logic for setting the iframe source and managing the loading spinner.
        function loadIframeContent(finalUrl) {
            const iframe = document.getElementById('feedback-iframe');
            const spinner = document.getElementById('loading-spinner');
            
            if (!iframe || !spinner) return;

            console.log("Loading URL:", finalUrl);

            // Show spinner while content loads
            spinner.style.display = 'block';
            iframe.style.opacity = '0';

            // Attach Load Listener to hide spinner when iframe content is ready
            iframe.onload = () => {
                spinner.style.display = 'none'; // Hide the spinner
                iframe.style.opacity = '1';    // Show the iframe content (fade in)
                iframe.onload = null;          // Clean up the listener
            };
            
            // Set the final, prefilled URL directly to the iframe's src
            iframe.setAttribute('src', finalUrl);
        }

        function openModal() {
            const modal = document.getElementById('feedback-modal');
            
            // NOTE: Spinner management is now handled by loadIframeContent()
            
            modal.style.display = "block";
            document.body.style.overflow = "hidden"; // Prevent scrolling while modal is open
        }

        function closeModal() {
            const modal = document.getElementById('feedback-modal'); // Corrected ID usage based on HTML structure
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }
        
        function handleCodeGate(code) {
            // Show the main content and hide the gate
            document.getElementById('feedback-links').style.display = 'block';
            document.getElementById('code-input-screen').style.display = 'none';
            // NOTE: loadIframeContent is no longer called here. It is called on button click.
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const dynamicCode = urlParams.get('code');
            const dynamicPwd = urlParams.get('pwd');
            let pwdString = "";
            
            const pageContent = document.getElementById('feedback-links');
            const codeInputScreen = document.getElementById('code-input-screen');

            if (dynamicCode) {
                // CASE 1: Code is present. Run the main app.
                handleCodeGate(dynamicCode);

                // --- LINK AND MODAL LOGIC START ---
                // Select ALL anchor elements that have the data-link-pattern attribute (our modal triggers)
                const anchorTriggers = document.querySelectorAll('a[data-link-pattern]');
                const codeToken = '{CODE}';
                const pwdToken = '{PWD}';

                anchorTriggers.forEach(anchor => {
                    const pattern = anchor.getAttribute('data-link-pattern');
                    
                    if (pattern) {
                      
                        // 1.5. If pwd was provided replace {PWD} in the string also
                        if(dynamicPwd) {
                          pwdString = dynamicCode + ":" +  dynamicPwd + "@";
                        } else {
                          pwdString = "";
                        }

                        const finalUrl = pattern.replace(codeToken, encodeURIComponent(dynamicCode)).replace(pwdToken,encodeURIComponent(pwdString));

                        // 2. Set the element's HREF with the final URL (Requested change)
                        anchor.setAttribute('href', finalUrl);
                        
                        
                        // 3. Attach the click listener
                        if (anchor.classList.contains('open-modal')) {
                          anchor.addEventListener('click', (e) => {
                              e.preventDefault(); 
                              const clickedAnchor = e.currentTarget; 
      
                              // 2. Read the final, updated URL from its href attribute
                              const iframeUrl = clickedAnchor.getAttribute('href');
                              
                              // *** FIX: Load the specific form into the iframe before opening the modal ***
                              loadIframeContent(iframeUrl); 
                              openModal();
                          });
                      }
                    }
                });
                // --- LINK AND MODAL LOGIC END ---

                // Attach close listeners for the modal
                const closeBtn = document.querySelector('.close');
                if (closeBtn) { closeBtn.addEventListener('click', closeModal); }
                window.onclick = function(event) {
                    const modal = document.getElementById('feedback-modal'); // Corrected ID usage
                    if (event.target == modal) { closeModal(); }
                }

            } else {
                // CASE 2: Code is NOT present. Show the input screen.
                pageContent.style.display = 'none';
                codeInputScreen.style.display = 'flex'; // Use flex for centering
                
                // Set up the form submission handler
                const form = document.getElementById('code-input-form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const inputField = document.getElementById('input-code');
                        const submittedCode = inputField.value.trim();
                        
                        if (submittedCode) {
                            // Redirect to the same page with the code in the query string
                            window.location.href = window.location.pathname + '?code=' + encodeURIComponent(submittedCode);
                        }
                    });
                }
            }
        });


    document.addEventListener('DOMContentLoaded', function() {
        const yearGroupSelect = document.getElementById('year-group-select');
        const groupNumberSelect = document.getElementById('group-number-select');
        const polisButton = document.getElementById('polis-button');

        if (yearGroupSelect && groupNumberSelect && polisButton) {
            // 1. Hide the button initially
            polisButton.style.display = 'none';

            function updateButtonState() {
                const yearGroup = yearGroupSelect.value;
                const groupNumber = groupNumberSelect.value;
                const baseHref = decodeURIComponent(polisButton.getAttribute('href')) || '';

                // Check if a valid Year Group has been selected
                if (yearGroup && yearGroup !== '') {
                    // Year group selected: Show the button and update URL
                    console.log(baseHref);
                    const suffix = `-${yearGroup}_${groupNumber}`;
                    const newHref = baseHref.split("-")[0] + suffix;
                    console.log(newHref);
                    
                    polisButton.setAttribute('href', newHref);
                    polisButton.style.display = 'inline-block'; // Or 'block' depending on styling
                } else {
                    // No year group selected: Hide the button and reset href
                    polisButton.style.display = 'none';
                }
            }

            // 2. Attach event listeners to both select elements
            yearGroupSelect.addEventListener('change', updateButtonState);
            groupNumberSelect.addEventListener('change', updateButtonState);

            // Run once on load to establish the initial state
            updateButtonState(); 
        }
    });
    </script>

    {%- include ai-in-education-header.html -%}

   

    <!-- === MAIN PAGE CONTENT (Hidden until code is confirmed) === -->
    <div id="page-content">

    <div id="code-input-screen">
      <section class="hero">
        <div class="hero-body">
                <div class="container is-max-desktop">
                    <h2 class="title">Enter Your Workshop Code</h2>
                    <div class="columns">
                      <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
                          <div class="content is-size-5">
                  
                                  <p class="subtitle is-6">Please enter the unique code provided for your group to access the feedback form. If you do not have a code, follow the sign-up links above.</p>
                                  <form id="code-input-form">
                                    <div class="field">
                                      <label class="label" for="input-code">Group Code:</label>
                                      <div class="control">
                                        <input class="input" type="text" id="input-code" placeholder="e.g., ABCDEF" required>
                                      </div>
                                    </div>
                                    <div class="field">
                                      <div class="control"> 
                                        <button class="button is-primary" type="submit">Access Page</button>
                                      </div>
                                    </div>
                                  </form>
                          </div>
                      </div>
                    </div>
                </div>
        </div>
      </section>       
    </div>
    
    <div id="feedback-links" style="display: none;">

      <section class="section" id="about">
        <div class="container is-max-desktop">
          <div class="columns">
            <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
              <div class="content is-size-5">
                {{ content }}
              </div>
            </div>
          </div>
        </div>
      </section>

     
      <section class="hero">
        <div class="hero-body">
          <div class="container is-max-desktop">
            <h2 class="title">Our say: Top tools</h2>
            <div class="columns">
              <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
              <div class="content is-size-5">
                  <p>Share feedback from the optional top-3/bottom-3 tools activity here.</p>
                
                  <div class="buttons">
                    <a class="button open-modal" 
                        id="tally-button" 
                        data-link-pattern="https://airtable.com/embed/appjXCj5YHXHNpVLL/pagVMlIIQ6DRajcEd/form?prefill_fldQOnptW0BfxG7VT={CODE}" 
                        href="#" 
                        target="_self">
                        <span class="icon-text">
                        <span class="icon">
                            <i class="fa-solid fa-ranking-star" aria-hidden="true"></i>
                        </span>
                        <span>Rank tools</span>
                        </span>
                    </a>
                </div>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

       <section class="hero highlight">
        <div class="hero-body">
          <div class="container is-max-desktop">
            <h2 class="title">Our say: agree / disagree</h2>
            <div class="columns">
              <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
              <div class="content is-size-5">
                  <p>Open pol.is to vote whether you agree or disagree with our messages to decision makers: and suggest your own group's message.</p>

                   <div class="field is-grouped is-grouped-multiline mb-4">
                      <div class="control">
                          <label class="label is-small">Year Group:</label>
                          <div class="select is-small">
                              <select id="year-group-select">
                                  <option value="">Select Year Group</option>
                                  <option value="Y6">Year 6</option>
                                  <option value="Y7">Year 7</option>
                                  <option value="Y8">Year 8</option>
                                  <option value="Y9">Year 9</option>
                                  <option value="Y10">Year 10</option>
                                  <option value="Y11">Year 11</option>
                                  <option value="Y12">Year 12</option>
                                  <option value="Y13">Year 13</option>
                              </select>
                          </div>
                      </div>
                      <div class="control">
                          <label class="label is-small">Group Number:</label>
                          <div class="select is-small">
                              <select id="group-number-select">
                                  {% for i in (1..30) %}
                                      <option value="{{ i }}">{{ i }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                      </div>
                  </div>

                  <div class="buttons">
                    <a class="button" 
                        id="polis-button" 
                        data-link-pattern="https://{PWD}polis.collectiveintelligence.policylab.gov.uk/9cddmhvesm?xid={CODE}" 
                        href="#" 
                        target="_blank">
                        <span class="icon-text">
                        <span class="icon">
                            <i class="fa-solid fa-check-to-slot" aria-hidden="true"></i>
                        </span>
                        <span>Vote Now</span>
                        </span>
                    </a>
                </div>
                <p><small>If you ran with a mixed year group, select the lowest yeargroup taking part. If you are running this activity with different groups, increment the group number to reset the list of questions displayed.</small></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="hero">
        <div class="hero-body">
          <div class="container is-max-desktop">
            <h2 class="title">Our say: Creative Expressions</h2>
            <div class="columns">
              <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
                <div class="content is-size-5">
                  <p>You can upload creative expression feedback from your group here.</p>
                </div>
                <div class="buttons">
                  <a class="button open-modal" 
                    id="modal-open-button-creative" 
                    data-link-pattern="https://airtable.com/embed/appjXCj5YHXHNpVLL/pagXxEik5vlC57vwe/form?prefill_fldFw5fR4CxROEnJA={CODE}" 
                    href="#" 
                    target="_self">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fa-solid fa-upload" aria-hidden="true"></i>
                      </span>
                      <span>Upload</span>
                    </span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>


       <section class="hero highlight">
        <div class="hero-body">
          <div class="container is-max-desktop">
            <h2 class="title">Session feedback</h2>
            <div class="columns">
              <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
                <div class="content is-size-5">
                  <p>At the end of your session you can send us any other views, and your facilitators feedback, here.</p>
                </div>
                <div class="buttons">
                  <a class="button open-modal" 
                    id="modal-open-button-session" 
                    data-link-pattern="https://airtable.com/embed/appjXCj5YHXHNpVLL/pag8AgDDB2yiztHRm/form?prefill_fldbsgaRgpM4LBwYe={CODE}" 
                    href="#" 
                    target="_self">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fa-solid fa-comment" aria-hidden="true"></i>
                      </span>
                      <span>Feedback</span>
                    </span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>


      


      <section class="section" id="about">
        <div class="container is-max-desktop">
          <h2 class="title">Independent, informed dialogue</h2>
          <div class="columns">
            <div class="column is-three-quarters-desktop is-three-quarters-fullhd">
              <div class="content is-size-5">
                <p>
                  The Workshop in a Box has been created by <a href="https://connectedbydata.org/">Connected by Data</a> for the Department for Education with input from independent experts on Artificial Intelligence in education. 
                </p>
                <p>
                  We believe that children, young people, families and educators all have the right to have a say on the future uses of Artificial Intelligence in education. This resource is here to help you have an informed discussion about the pros and cons of AI: and to develop and share your own views on AI.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
    </div>
      {%- include ai-in-education-footer.html -%}
    
    
    <!-- === END MAIN PAGE CONTENT === -->

    <!-- === AIRTABLE MODAL === -->
    <!-- NOTE: Renamed ID to 'feedback-modal' for consistency with JS functions -->
    <div id="feedback-modal" class="modal"> 
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="loading-spinner"></div> 
        <iframe 
            id="feedback-iframe" 
            class="airtable-embed" 
            src="" 
            frameborder="0" 
            onmousewheel="" 
            width="100%" 
            height="100%" 
            style="background: white;">
        </iframe>
      </div>
    </div>
    <!-- === END AIRTABLE MODAL === -->

  </body>

</html>
